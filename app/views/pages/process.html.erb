<!-- app/views/pages/process.html.erb -->
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="mb-0">Результати перевірки</h3>
          <p class="text-muted mb-0">
            Файл: <strong><%= @file_data[:name] %></strong> •
            Рядків (email): <strong><%= @total %></strong>
          </p>
        </div>

        <div class="card-body">
          <% total     = (@total || 0).to_i %>
          <% valid     = (@valid_count || 0).to_i %>
          <% invalid   = (@invalid_count || 0).to_i %>
          <% processed = (@processed || 0).to_i %>
          <% unknown   = (@unknown_count || [processed - valid - invalid, 0].max).to_i %>
          <% pct = ->(count, tot) { tot <= 0 ? 0 : ((count.to_f / tot) * 100).round(1) } %>

          <!-- ===== ГЛОБАЛЬНИЙ ПРОГРЕС-БАР (на всю ширину) ===== -->
          <div class="global-progress mb-4">
            <div class="d-flex justify-content-between align-items-baseline mb-2">
              <div class="fw-semibold">Прогрес перевірки</div>
              <div class="text-muted small">
                Опрацьовано: <strong id="processed-counter"><%= processed %></strong> /
                Загалом: <strong id="total-counter"><%= total %></strong>
              </div>
            </div>

            <div class="progress progress-xl">
              <div class="progress-bar bg-success" role="progressbar"
                   id="bar-valid" style="width: <%= pct.call(valid, total) %>%;">
                Валідні: <span id="valid-progress-count"><%= valid %></span>
              </div>
              <div class="progress-bar bg-danger" role="progressbar"
                   id="bar-invalid" style="width: <%= pct.call(invalid, total) %>%;">
                Невалідні: <span id="invalid-progress-count"><%= invalid %></span>
              </div>
              <div class="progress-bar bg-secondary" role="progressbar"
                   id="bar-unknown" style="width: <%= pct.call(unknown, total) %>%;">
                Невідомі: <span id="unknown-progress-count"><%= unknown %></span>
              </div>
            </div>
          </div>
          <!-- ===== /ГЛОБАЛЬНИЙ ПРОГРЕС-БАР ===== -->

          <!-- ===== ВЕРХНІ БЛОКИ ===== -->
          <div class="row g-3">
            <!-- Ліва колонка -->
            <div class="col-12 col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Загалом</span>
                      <strong id="total-counter-dup"><%= total %></strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Опрацьовано</span>
                      <strong id="processed-counter-dup"><%= processed %></strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <a href="javascript:void(0)" class="text-success fw-semibold" id="show-valid" style="text-decoration:none;">Валідні</a>
                      <span class="badge bg-success rounded-pill" id="valid-badge-count"><%= valid %></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <a href="javascript:void(0)" class="text-danger fw-semibold" id="show-invalid" style="text-decoration:none;">Невалідні</a>
                      <span class="badge bg-danger rounded-pill" id="invalid-badge-count"><%= invalid %></span>
                    </li>
                  </ul>

                  <button class="btn btn-primary w-100" id="start-validation">Почати перевірку</button>
                </div>
              </div>
            </div>

            <!-- Права колонка (список валідні/невалідні) -->
            <div class="col-12 col-lg-6">
              <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="fw-semibold" id="list-title">Невалідні адреси</span>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" id="copy-list" type="button">Скопіювати</button>
                    <button class="btn btn-sm btn-outline-primary" id="download-list" type="button">Завантажити .txt</button>
                  </div>
                </div>
                <div class="card-body">
                  <div id="list-pane" class="d-flex border rounded overflow-hidden">
                    <pre id="ln-gutter" class="mb-0 px-2 py-2 text-muted border-end">1</pre>
                    <textarea id="list-box"
                              class="form-control border-0 font-monospace"
                              rows="10"
                              readonly
                              placeholder="Тут з’явиться список валідних/невалідних адрес..."></textarea>
                  </div>
                </div>
                <div class="card-footer small text-muted">
                  Клікніть «Валідні» або «Невалідні» зліва, щоб перемкнути цей список.
                </div>
              </div>
            </div>
          </div>
          <!-- ===== /ВЕРХНІ БЛОКИ ===== -->

          <!-- ===== НИЖНІЙ БЛОК: ДЕТАЛЬНА ІНФОРМАЦІЯ ===== -->
          <div class="mt-4">
            <div class="card">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <strong>Детальна інформація перевірки</strong>
                  <small class="text-muted">Перемикачі нижче відкривають список у правому полі цього блоку</small>
                </div>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <!-- Ліворуч: резюме + перемикачі -->
                  <div class="col-12 col-lg-5">
                    <ul class="list-group mb-3">
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="javascript:void(0)" class="fw-semibold text-warning" id="detail-show-role" style="text-decoration:none;">Службові адреси</a>
                        <span class="badge bg-warning text-dark rounded-pill" id="detail-role-badge">0</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="javascript:void(0)" class="fw-semibold text-info" id="detail-show-duplicates" style="text-decoration:none;">Дублікати</a>
                        <span class="badge bg-info text-dark rounded-pill" id="detail-dup-badge">0</span>
                      </li>
                    </ul>

                    <div class="alert alert-secondary small mb-0">
                      <div class="mb-1"><strong>Пояснення:</strong></div>
                      <ul class="mb-0 ps-3">
                        <li><em>Службові</em>: admin, support, info тощо — відсіюємо для розсилок фізичним особам.</li>
                        <li><em>Дублікати</em>: повторні адреси у вхідному файлі.</li>
                      </ul>
                    </div>
                  </div>

                  <!-- Праворуч: textarea з нумерацією -->
                  <div class="col-12 col-lg-7">
                    <div class="card h-100 border-0">
                      <div class="card-header d-flex justify-content-between align-items-center px-0">
                        <span class="fw-semibold" id="detail-list-title">Службові адреси</span>
                        <div class="d-flex gap-2">
                          <button class="btn btn-sm btn-outline-secondary" id="detail-copy-list" type="button">Скопіювати</button>
                          <button class="btn btn-sm btn-outline-primary" id="detail-download-list" type="button">Завантажити .txt</button>
                        </div>
                      </div>
                      <div class="card-body px-0">
                        <div id="detail-list-pane" class="d-flex border rounded overflow-hidden">
                          <pre id="detail-ln-gutter" class="mb-0 px-2 py-2 text-muted border-end">1</pre>
                          <textarea id="detail-list-box"
                                    class="form-control border-0 font-monospace"
                                    rows="10"
                                    readonly
                                    placeholder="Тут будуть службові або дублікати (залежно від перемикача ліворуч)"></textarea>
                        </div>
                      </div>
                      <div class="card-footer small text-muted px-0">
                        Перемикайте «Службові / Дублікати» ліворуч, щоб оновити цей список.
                      </div>
                    </div>
                  </div>
                </div> <!-- /row -->
              </div>
            </div>
          </div>
          <!-- ===== /ДЕТАЛЬНА ІНФОРМАЦІЯ ===== -->

        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== СТИЛІ ===== -->
<style>
  /* Товстий глобальний прогрес-бар */
  .progress.progress-xl {
    height: 32px;
    border-radius: 12px;
    overflow: hidden;
  }
  .progress.progress-xl .progress-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
  }

  /* Панелі списків (верх і низ) */
  #list-pane, #detail-list-pane {
    height: 320px;
    min-height: 200px;
    max-height: 70vh;
    resize: vertical;
    overflow: hidden; /* скролиться textarea */
  }
  #ln-gutter, #list-box,
  #detail-ln-gutter, #detail-list-box {
    height: 100%;
  }
  #ln-gutter, #detail-ln-gutter {
    min-width: 3.2rem;
    text-align: right;
    user-select: none;
    overflow: hidden;
    line-height: 1.5;
    background: #f8f9fa;
  }
  #list-box, #detail-list-box {
    resize: none; /* ресайзимо контейнер */
    line-height: 1.5;
  }
</style>

<!-- Легка анімація тільки для глобального прогрес-бара -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".progress.progress-xl .progress-bar").forEach(bar => {
      const width = bar.style.width;
      bar.style.width = "0";
      setTimeout(() => { bar.style.width = width; }, 250);
    });
  });
</script>

<!-- ===== JS: запуск джоби, опитування прогресу, оновлення UI ===== -->
<script>
  // Дані
  const emails = <%= raw @emails.to_json %>;
  const csrf   = document.querySelector('meta[name="csrf-token"]')?.content || '';

  // Глобальні лічильники у шапці прогресу
  const totalTopEl     = document.getElementById('total-counter');
  const processedTopEl = document.getElementById('processed-counter');

  // Дублікати лічильників у лівому блоці (можуть бути відсутні)
  const totalSideEl     = document.getElementById('total-counter-dup');
  const processedSideEl = document.getElementById('processed-counter-dup');

  // Сегменти глобального прогрес-бара + цифри всередині
  const barValid      = document.getElementById('bar-valid');
  const barInvalid    = document.getElementById('bar-invalid');
  const barUnknown    = document.getElementById('bar-unknown');
  const validProgEl   = document.getElementById('valid-progress-count');
  const invalidProgEl = document.getElementById('invalid-progress-count');
  const unknownProgEl = document.getElementById('unknown-progress-count');

  // Бейджі у лівому блоці
  const validBadgeEl   = document.getElementById('valid-badge-count');
  const invalidBadgeEl = document.getElementById('invalid-badge-count');

  // Верхній правий список
  const listPane        = document.getElementById('list-pane');
  const listTitleEl     = document.getElementById('list-title');
  const listBoxEl       = document.getElementById('list-box');
  const gutterEl        = document.getElementById('ln-gutter');
  const copyBtn         = document.getElementById('copy-list');
  const downloadBtn     = document.getElementById('download-list');
  const showValidBtn    = document.getElementById('show-valid');
  const showInvalidBtn  = document.getElementById('show-invalid');

  // Нижній блок (деталі)
  const roleBadgeDetailEl  = document.getElementById('detail-role-badge');
  const dupBadgeDetailEl   = document.getElementById('detail-dup-badge');
  const detailListPane     = document.getElementById('detail-list-pane');
  const detailListTitleEl  = document.getElementById('detail-list-title');
  const detailListBoxEl    = document.getElementById('detail-list-box');
  const detailGutterEl     = document.getElementById('detail-ln-gutter');
  const detailCopyBtn      = document.getElementById('detail-copy-list');
  const detailDownloadBtn  = document.getElementById('detail-download-list');
  const detailShowRoleBtn  = document.getElementById('detail-show-role');
  const detailShowDupBtn   = document.getElementById('detail-show-duplicates');

  // Буфери списків
  let validList       = [];
  let invalidList     = [];
  let roleList        = [];
  let duplicatesList  = [];

  // Поточні режими
  let currentListModeTop    = 'invalid';   // 'valid' | 'invalid'
  let currentListModeDetail = 'role';      // 'role'  | 'duplicates'

  // Кнопка старту та таймер
  const startBtn = document.getElementById('start-validation');
  let jobId  = null;
  let timer  = null;

  // Утиліти
  function pct(count, total) {
    total = parseInt(total || 0, 10);
    count = parseInt(count || 0, 10);
    if (total <= 0) return 0;
    return Math.round((count / total) * 100);
  }

  // ==== Верхній правий список (нумерація/ресайз) ====
  function sizeListPane() {
    if (!listPane) return;
    const h = listPane.clientHeight;
    listBoxEl.style.height = h + 'px';
    gutterEl.style.height  = h + 'px';
    gutterEl.scrollTop = listBoxEl.scrollTop;
  }
  if (window.ResizeObserver && listPane) {
    new ResizeObserver(sizeListPane).observe(listPane);
  } else {
    window.addEventListener('resize', sizeListPane);
  }
  document.addEventListener('DOMContentLoaded', sizeListPane);

  function refreshGutter() {
    if (!listBoxEl || !gutterEl) return;
    const lines = (listBoxEl.value || '').split('\n').length || 1;
    let out = '';
    for (let i = 1; i <= lines; i++) out += i + '\n';
    gutterEl.textContent = out.trimEnd() || '1';
    gutterEl.scrollTop = listBoxEl.scrollTop;
  }
  listBoxEl?.addEventListener('scroll', () => { if (gutterEl) gutterEl.scrollTop = listBoxEl.scrollTop; });

  function setTopListMode(mode) {
    currentListModeTop = mode;
    if (!listBoxEl || !listTitleEl) return;
    if (mode === 'valid') {
      listTitleEl.textContent = 'Валідні адреси';
      listBoxEl.value = (validList || []).join('\n');
    } else {
      listTitleEl.textContent = 'Невалідні адреси';
      listBoxEl.value = (invalidList || []).join('\n');
    }
    refreshGutter();
    sizeListPane();
  }
  showValidBtn?.addEventListener('click',  () => setTopListMode('valid'));
  showInvalidBtn?.addEventListener('click',() => setTopListMode('invalid'));

  // ==== Нижній детальний список (нумерація/ресайз) ====
  function sizeDetailPane() {
    if (!detailListPane) return;
    const h = detailListPane.clientHeight;
    detailListBoxEl.style.height = h + 'px';
    detailGutterEl.style.height  = h + 'px';
    detailGutterEl.scrollTop = detailListBoxEl.scrollTop;
  }
  if (window.ResizeObserver && detailListPane) {
    new ResizeObserver(sizeDetailPane).observe(detailListPane);
  } else {
    window.addEventListener('resize', sizeDetailPane);
  }
  document.addEventListener('DOMContentLoaded', sizeDetailPane);

  function refreshDetailGutter() {
    const lines = (detailListBoxEl.value || '').split('\n').length || 1;
    let out = '';
    for (let i = 1; i <= lines; i++) out += i + '\n';
    detailGutterEl.textContent = out.trimEnd() || '1';
    detailGutterEl.scrollTop = detailListBoxEl.scrollTop;
  }
  detailListBoxEl?.addEventListener('scroll', () => { detailGutterEl.scrollTop = detailListBoxEl.scrollTop; });

  function setDetailListMode(mode) {
    currentListModeDetail = mode;
    if (!detailListBoxEl || !detailListTitleEl) return;
    if (mode === 'duplicates') {
      detailListTitleEl.textContent = 'Дублікати';
      detailListBoxEl.value = (duplicatesList || []).join('\n');
    } else {
      detailListTitleEl.textContent = 'Службові адреси';
      detailListBoxEl.value = (roleList || []).join('\n');
    }
    refreshDetailGutter();
    sizeDetailPane();
  }
  detailShowRoleBtn?.addEventListener('click', () => setDetailListMode('role'));
  detailShowDupBtn?.addEventListener('click',  () => setDetailListMode('duplicates'));

  // Копіювання / Завантаження (верх)
  copyBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(listBoxEl.value || '');
      copyBtn.textContent = 'Скопійовано!';
      setTimeout(() => (copyBtn.textContent = 'Скопіювати'), 1200);
    } catch {
      listBoxEl.select(); document.execCommand('copy');
    }
  });
  downloadBtn?.addEventListener('click', () => {
    const prefix   = (currentListModeTop === 'valid') ? 'valid' : 'invalid';
    const filename = `${prefix}_emails_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
    const blob     = new Blob([listBoxEl.value || ''], { type: 'text/plain;charset=utf-8' });
    const url      = URL.createObjectURL(blob);
    const a        = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Копіювання / Завантаження (низ)
  detailCopyBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(detailListBoxEl.value || '');
      detailCopyBtn.textContent = 'Скопійовано!';
      setTimeout(() => (detailCopyBtn.textContent = 'Скопіювати'), 1200);
    } catch {
      detailListBoxEl.select(); document.execCommand('copy');
    }
  });
  detailDownloadBtn?.addEventListener('click', () => {
    const prefix   = (currentListModeDetail === 'duplicates') ? 'duplicates' : 'role';
    const filename = `${prefix}_emails_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
    const blob     = new Blob([detailListBoxEl.value || ''], { type: 'text/plain;charset=utf-8' });
    const url      = URL.createObjectURL(blob);
    const a        = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // ===== Старт перевірки =====
  startBtn?.addEventListener('click', async () => {
    if (!Array.isArray(emails) || emails.length === 0) {
      alert('Список email порожній'); return;
    }
    startBtn.disabled = true;
    const originalText = startBtn.textContent;
    startBtn.textContent = 'Запускаю...';

    try {
      const resp = await fetch('<%= bulk_validate_emails_path %>', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf, 'Accept': 'application/json' },
        body: JSON.stringify({ emails })
      });
      const data = await resp.json();
      if (!data.success) throw new Error(data.error || 'Не вдалося запустити перевірку');

      jobId = data.job_id;

      // Нульовий стан
      updateUI({
        total: emails.length, processed: 0,
        valid: 0, invalid: 0,
        valid_list: [], invalid_list: [],
        role_rejected: 0, role_list: [],
        duplicates: 0, duplicates_list: []
      });

      setTopListMode('invalid');
      setDetailListMode('role');

    timer = setInterval(fetchProgress, 1200);
    } catch (e) {
      alert('Помилка: ' + e.message);
      startBtn.disabled = false;
      startBtn.textContent = originalText;
    }
  });

  // Опитування прогресу
  async function fetchProgress() {
    try {
      const url  = '<%= progress_emails_path %>?job_id=' + encodeURIComponent(jobId);
      const data = await fetch(url, { headers: { 'Accept': 'application/json' } }).then(r => r.json());
      if (!data.success) return;

      updateUI(data);

      if (data.done) {
        clearInterval(timer);
        startBtn.textContent = 'Повторити перевірку';
        startBtn.disabled = false;
      }
    } catch { /* no-op */ }
  }

  // Оновлення інтерфейсу
  function updateUI(state) {
    const total     = state.total || emails.length;
    const processed = state.processed || 0;
    const valid     = state.valid || 0;
    const invalid   = state.invalid || 0;
    const unknown   = Math.max(0, processed - valid - invalid);

    const roleCount = state.role_rejected || 0;
    const dupCount  = (state.duplicates != null ? state.duplicates : state.duplicate_count) || 0;

    // Тотали/лічильники
    totalTopEl     && (totalTopEl.textContent     = total);
    processedTopEl && (processedTopEl.textContent = processed);
    totalSideEl     && (totalSideEl.textContent     = total);
    processedSideEl && (processedSideEl.textContent = processed);

    // Прогрес-бар
    barValid   && (barValid.style.width   = pct(valid, total)   + '%');
    barInvalid && (barInvalid.style.width = pct(invalid, total) + '%');
    barUnknown && (barUnknown.style.width = pct(unknown, total) + '%');

    validProgEl   && (validProgEl.textContent   = valid);
    invalidProgEl && (invalidProgEl.textContent = invalid);
    unknownProgEl && (unknownProgEl.textContent = unknown);

    // Бейджі «валідні/невалідні»
    validBadgeEl   && (validBadgeEl.textContent   = valid);
    invalidBadgeEl && (invalidBadgeEl.textContent = invalid);

    // Нижні бейджі (службові/дублікати)
    roleBadgeDetailEl && (roleBadgeDetailEl.textContent = roleCount);
    dupBadgeDetailEl  && (dupBadgeDetailEl.textContent  = dupCount);

    // Списки
    validList      = Array.isArray(state.valid_list)      ? state.valid_list      : [];
    invalidList    = Array.isArray(state.invalid_list)    ? state.invalid_list    : [];
    roleList       = Array.isArray(state.role_list)       ? state.role_list       : [];
    duplicatesList = Array.isArray(state.duplicates_list) ? state.duplicates_list : [];

    // Перерендерити відповідно до активних режимів
    setTopListMode(currentListModeTop);
    setDetailListMode(currentListModeDetail);
  }
</script>
