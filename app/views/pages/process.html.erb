<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="mb-0">Результати перевірки</h3>
          <p class="text-muted mb-0">
            Файл: <strong><%= @file_data[:name] %></strong> •
            Розмір: <strong><%= number_to_human_size(@file_data[:size]) %></strong>
          </p>
        </div>

        <div class="card-body">
          <% total     = (@total || 0).to_i %>
          <% valid     = (@valid_count || 0).to_i %>
          <% invalid   = (@invalid_count || 0).to_i %>
          <% processed = (@processed || 0).to_i %>
          <% unknown   = (@unknown_count || [processed - valid - invalid, 0].max).to_i %>
          <% pct = ->(count, tot) { tot <= 0 ? 0 : ((count.to_f / tot) * 100).round(1) } %>

          <!-- ===== ГЛОБАЛЬНИЙ ПРОГРЕС-БАР ===== -->
          <div class="global-progress mb-4">
            <div class="d-flex justify-content-between align-items-baseline mb-2">
              <div class="fw-semibold">Прогрес перевірки</div>
              <div class="text-muted small">
                Опрацьовано: <strong id="processed-counter"><%= processed %></strong> /
                Загалом: <strong id="total-counter"><%= total %></strong>
              </div>
            </div>

            <div class="progress progress-xl">
              <div class="progress-bar bg-success" role="progressbar"
                   id="bar-valid" style="width: <%= pct.call(valid, total) %>%;">
                Валідні: <span id="valid-progress-count"><%= valid %></span>
              </div>
              <div class="progress-bar bg-danger" role="progressbar"
                   id="bar-invalid" style="width: <%= pct.call(invalid, total) %>%;">
                Невалідні: <span id="invalid-progress-count"><%= invalid %></span>
              </div>
              <div class="progress-bar bg-secondary" role="progressbar"
                   id="bar-unknown" style="width: <%= pct.call(unknown, total) %>%;">
                Невідомі: <span id="unknown-progress-count"><%= unknown %></span>
              </div>
            </div>
          </div>
          <!-- ===== /ГЛОБАЛЬНИЙ ПРОГРЕС-БАР ===== -->

          <!-- ===== ВЕРХНІ БЛОКИ ===== -->
          <div class="row g-3">
            <!-- Ліва колонка -->
            <div class="col-12 col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Загалом</span>
                      <strong id="total-counter-dup"><%= total %></strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Опрацьовано</span>
                      <strong id="processed-counter-dup"><%= processed %></strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <a href="javascript:void(0)" class="text-success fw-semibold" id="show-valid" style="text-decoration:none;">Валідні</a>
                      <span class="badge bg-success rounded-pill" id="valid-badge-count"><%= valid %></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <a href="javascript:void(0)" class="text-danger fw-semibold" id="show-invalid" style="text-decoration:none;">Невалідні</a>
                      <span class="badge bg-danger rounded-pill" id="invalid-badge-count"><%= invalid %></span>
                    </li>
                  </ul>

                  <button class="btn btn-primary w-100" id="start-validation">Почати перевірку</button>
                </div>
              </div>
            </div>

            <!-- Права колонка (список валідні/невалідні) -->
            <div class="col-12 col-lg-6">
              <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="fw-semibold" id="list-title">Невалідні адреси</span>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" id="copy-list" type="button">Скопіювати</button>
                    <button class="btn btn-sm btn-outline-primary" id="download-list" type="button">Завантажити .txt</button>
                  </div>
                </div>
                <div class="card-body">
                  <div id="list-pane" class="d-flex border rounded overflow-hidden">
                    <pre id="ln-gutter" class="mb-0 px-2 py-2 text-muted border-end">1</pre>
                    <textarea id="list-box"
                              class="form-control border-0 font-monospace"
                              rows="10"
                              readonly
                              placeholder="Тут з’явиться список валідних/невалідних адрес..."></textarea>
                  </div>
                </div>
                <div class="card-footer small text-muted">
                  Клікніть «Валідні» або «Невалідні» зліва, щоб перемкнути цей список.
                </div>
              </div>
            </div>
          </div>
          <!-- ===== /ВЕРХНІ БЛОКИ ===== -->

          <!-- ===== НИЖНІЙ БЛОК: ДЕТАЛІ (chunk + download) ===== -->
          <div class="mt-4">
            <div class="card">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <strong>Детальна інформація перевірки</strong>
                  <small class="text-muted">Великі списки підвантажуються частинами</small>
                </div>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <!-- Ліворуч: резюме + перемикачі + скачування -->
                  <div class="col-12 col-lg-5">
                    <ul class="list-group mb-3">
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="javascript:void(0)" class="fw-semibold text-warning" id="detail-show-role" style="text-decoration:none;">Службові адреси</a>
                        <span class="badge bg-warning text-dark rounded-pill" id="detail-role-badge">0</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="javascript:void(0)" class="fw-semibold text-info" id="detail-show-duplicates" style="text-decoration:none;">Дублікати</a>
                        <span class="badge bg-info text-dark rounded-pill" id="detail-dup-badge">0</span>
                      </li>
                    </ul>

                    <div class="d-flex flex-wrap gap-2 mb-3">
                      <a id="dl-role" class="btn btn-sm btn-outline-primary disabled" href="#" aria-disabled="true">Завантажити службові</a>
                      <a id="dl-duplicates" class="btn btn-sm btn-outline-primary disabled" href="#" aria-disabled="true">Завантажити дублікати</a>
                    </div>

                    <div class="alert alert-secondary small mb-0">
                      <div class="mb-1"><strong>Пояснення:</strong></div>
                      <ul class="mb-0 ps-3">
                        <li><em>Службові</em>: admin, support, info тощо.</li>
                        <li><em>Дублікати</em>: повторні адреси у вхідному файлі.</li>
                      </ul>
                    </div>
                  </div>

                  <!-- Праворуч: textarea + “Показати ще” -->
                  <div class="col-12 col-lg-7">
                    <div class="card h-100 border-0">
                      <div class="card-header d-flex justify-content-between align-items-center px-0">
                        <span class="fw-semibold" id="detail-list-title">Службові адреси</span>
                        <div class="d-flex gap-2">
                          <button class="btn btn-sm btn-outline-secondary" id="detail-copy-list" type="button">Скопіювати</button>
                          <button class="btn btn-sm btn-outline-dark" id="detail-clear-list" type="button">Очистити</button>
                          <button class="btn btn-sm btn-outline-primary" id="detail-load-more" type="button" disabled>Показати ще</button>
                        </div>
                      </div>
                      <div class="card-body px-0">
                        <div id="detail-list-pane" class="d-flex border rounded overflow-hidden">
                          <pre id="detail-ln-gutter" class="mb-0 px-2 py-2 text-muted border-end">1</pre>
                          <textarea id="detail-list-box"
                                    class="form-control border-0 font-monospace"
                                    rows="10"
                                    readonly
                                    placeholder="Тут будуть службові або дублікати (натисніть «Показати ще», щоб підвантажити наступну частину)."></textarea>
                        </div>
                      </div>
                      <div class="card-footer small text-muted px-0">
                        Кожне натискання «Показати ще» тягне наступні <code>500</code> рядків.
                      </div>
                    </div>
                  </div>
                </div> <!-- /row -->
              </div>
            </div>
          </div>
          <!-- ===== /ДЕТАЛІ ===== -->

        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== СТИЛІ ===== -->
<style>
  .progress.progress-xl { height: 32px; border-radius: 12px; overflow: hidden; }
  .progress.progress-xl .progress-bar { display:flex; align-items:center; justify-content:center; font-weight:600; }

  #list-pane, #detail-list-pane { height:320px; min-height:200px; max-height:70vh; resize:vertical; overflow:hidden; }
  #ln-gutter, #list-box, #detail-ln-gutter, #detail-list-box { height:100%; }
  #ln-gutter, #detail-ln-gutter { min-width:3.2rem; text-align:right; user-select:none; overflow:hidden; line-height:1.5; background:#f8f9fa; }
  #list-box, #detail-list-box { resize:none; line-height:1.5; white-space:pre; }
  a.disabled { pointer-events:none; opacity:.65; }
</style>

<!-- Анімація стартових барів -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".progress.progress-xl .progress-bar").forEach(bar => {
      const width = bar.style.width; bar.style.width = "0"; setTimeout(() => { bar.style.width = width; }, 250);
    });
  });
</script>

<!-- ===== ЛОГІКА СТОРІНКИ ===== -->
<script>
  // ключ завантаження (PagesController#set @job_key)
  const uploadKey = "<%= @job_key %>";
  const emails    = []; // fallback на випадок старого режиму
  const csrf      = document.querySelector('meta[name="csrf-token"]')?.content || '';

  // Верхні лічильники + прогрес
  const totalEl      = document.getElementById('total-counter');
  const processedEl  = document.getElementById('processed-counter');
  const totalDupEl   = document.getElementById('total-counter-dup');
  const processedDupEl = document.getElementById('processed-counter-dup');

  const barValid      = document.getElementById('bar-valid');
  const barInvalid    = document.getElementById('bar-invalid');
  const barUnknown    = document.getElementById('bar-unknown');
  const validProgEl   = document.getElementById('valid-progress-count');
  const invalidProgEl = document.getElementById('invalid-progress-count');
  const unknownProgEl = document.getElementById('unknown-progress-count');

  const validBadgeEl   = document.getElementById('valid-badge-count');
  const invalidBadgeEl = document.getElementById('invalid-badge-count');

  // Верхній правий список
  const listPane      = document.getElementById('list-pane');
  const listTitleEl   = document.getElementById('list-title');
  const listBoxEl     = document.getElementById('list-box');
  const gutterEl      = document.getElementById('ln-gutter');
  const copyBtn       = document.getElementById('copy-list');
  const downloadBtn   = document.getElementById('download-list');
  const showValidBtn  = document.getElementById('show-valid');
  const showInvalidBtn= document.getElementById('show-invalid');

  // Нижній блок
  const roleBadgeDetailEl  = document.getElementById('detail-role-badge');
  const dupBadgeDetailEl   = document.getElementById('detail-dup-badge');
  const detailListPane     = document.getElementById('detail-list-pane');
  const detailListTitleEl  = document.getElementById('detail-list-title');
  const detailListBoxEl    = document.getElementById('detail-list-box');
  const detailGutterEl     = document.getElementById('detail-ln-gutter');
  const detailCopyBtn      = document.getElementById('detail-copy-list');
  const detailClearBtn     = document.getElementById('detail-clear-list');
  const detailLoadMoreBtn  = document.getElementById('detail-load-more');
  const detailShowRoleBtn  = document.getElementById('detail-show-role');
  const detailShowDupBtn   = document.getElementById('detail-show-duplicates');
  const dlRoleEl           = document.getElementById('dl-role');
  const dlDupEl            = document.getElementById('dl-duplicates');

  let validList   = [];
  let invalidList = [];

  let currentListModeTop = 'invalid';  // 'valid' | 'invalid'
  let currentDetailKind  = 'role';     // 'role' | 'duplicates'
  let jobId = null;
  let timer = null;

  // Стан для чанків
  let detailOffset = 0;
  let detailEOF    = false;
  const DETAIL_LIMIT = 500;

  function pct(count, total) {
    total = parseInt(total || 0, 10);
    count = parseInt(count || 0, 10);
    if (total <= 0) return 0;
    return Math.round((count / total) * 100);
  }

  // Верхній список: ресайз/нумерація
  function sizeListPane(){ if(!listPane) return; const h=listPane.clientHeight; listBoxEl.style.height=h+'px'; gutterEl.style.height=h+'px'; gutterEl.scrollTop=listBoxEl.scrollTop; }
  if (window.ResizeObserver && listPane){ new ResizeObserver(sizeListPane).observe(listPane); } else { window.addEventListener('resize', sizeListPane); }
  document.addEventListener('DOMContentLoaded', sizeListPane);

  function refreshGutter(){ const lines=(listBoxEl.value||'').split('\n').length||1; let out=''; for(let i=1;i<=lines;i++) out+=i+'\n'; gutterEl.textContent=out.trimEnd()||'1'; gutterEl.scrollTop=listBoxEl.scrollTop; }
  listBoxEl.addEventListener('scroll', ()=>{ gutterEl.scrollTop=listBoxEl.scrollTop; });

  function setTopListMode(mode){
    currentListModeTop=mode;
    if(mode==='valid'){ listTitleEl.textContent='Валідні адреси'; listBoxEl.value=(validList||[]).join('\n'); }
    else { listTitleEl.textContent='Невалідні адреси'; listBoxEl.value=(invalidList||[]).join('\n'); }
    refreshGutter(); sizeListPane();
  }

  // Нижній список: ресайз/нумерація
  function sizeDetailPane(){ if(!detailListPane) return; const h=detailListPane.clientHeight; detailListBoxEl.style.height=h+'px'; detailGutterEl.style.height=h+'px'; detailGutterEl.scrollTop=detailListBoxEl.scrollTop; }
  if (window.ResizeObserver && detailListPane){ new ResizeObserver(sizeDetailPane).observe(detailListPane); } else { window.addEventListener('resize', sizeDetailPane); }
  document.addEventListener('DOMContentLoaded', sizeDetailPane);

  function refreshDetailGutter(){ const lines=(detailListBoxEl.value||'').split('\n').length||1; let out=''; for(let i=1;i<=lines;i++) out+=i+'\n'; detailGutterEl.textContent=out.trimEnd()||'1'; detailGutterEl.scrollTop=detailListBoxEl.scrollTop; }
  detailListBoxEl.addEventListener('scroll', ()=>{ detailGutterEl.scrollTop=detailListBoxEl.scrollTop; });

  function setDetailListMode(mode){
    currentDetailKind = mode;
    detailListTitleEl.textContent = (mode==='duplicates') ? 'Дублікати' : 'Службові адреси';
    detailOffset = 0; detailEOF=false; detailListBoxEl.value=''; refreshDetailGutter();
    detailLoadMoreBtn.disabled = !jobId;
    if (jobId) loadNextDetailChunk();
  }

  async function fetchArtifactChunk(kind, offset, limit=DETAIL_LIMIT){
    const url = "<%= chunk_emails_path %>?job_id="+encodeURIComponent(jobId)+"&kind="+encodeURIComponent(kind)+"&offset="+offset+"&limit="+limit;
    const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
    const data = await r.json();
    if(!data.success) throw new Error(data.error || 'chunk failed');
    return data;
  }

  async function loadNextDetailChunk(){
    if(!jobId || detailEOF) return;
    detailLoadMoreBtn.disabled = true; detailLoadMoreBtn.textContent='Завантаження...';
    try{
      const { items, next_offset, eof } = await fetchArtifactChunk(currentDetailKind, detailOffset, DETAIL_LIMIT);
      if(Array.isArray(items) && items.length>0){
        if (detailListBoxEl.value && !detailListBoxEl.value.endsWith('\n')) detailListBoxEl.value += '\n';
        detailListBoxEl.value += items.join('\n'); refreshDetailGutter();
      }
      detailOffset = next_offset ?? detailOffset; detailEOF = !!eof;
    }catch(e){ alert('Помилка завантаження: '+e.message); }
    finally{
      detailLoadMoreBtn.textContent = detailEOF ? 'Кінець списку' : 'Показати ще';
      detailLoadMoreBtn.disabled = detailEOF || !jobId;
    }
  }

  // Перемикачі нижнього блоку
  detailShowRoleBtn?.addEventListener('click', ()=> setDetailListMode('role'));
  detailShowDupBtn?.addEventListener('click',  ()=> setDetailListMode('duplicates'));
  detailLoadMoreBtn?.addEventListener('click', loadNextDetailChunk);
  detailClearBtn?.addEventListener('click', ()=>{ detailListBoxEl.value=''; refreshDetailGutter(); });

  // Копіювання/завантаження (верх)
  copyBtn?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(listBoxEl.value||''); copyBtn.textContent='Скопійовано!'; setTimeout(()=>copyBtn.textContent='Скопіювати',1200); }
    catch(_){ listBoxEl.select(); document.execCommand('copy'); }
  });
  downloadBtn?.addEventListener('click', ()=>{
    const prefix = (currentListModeTop==='valid') ? 'valid' : 'invalid';
    const filename = `${prefix}_emails_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
    const blob = new Blob([listBoxEl.value||''], { type:'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Верхні перемикачі
  showValidBtn?.addEventListener('click', ()=> setTopListMode('valid'));
  showInvalidBtn?.addEventListener('click',()=> setTopListMode('invalid'));

  // Старт перевірки — надсилаємо KEY
  const startBtn = document.getElementById('start-validation');
  startBtn?.addEventListener('click', async ()=>{
    startBtn.disabled = true; startBtn.textContent = 'Запускаю...';
    try{
      const payload = uploadKey ? { key: uploadKey } : { emails };
      const resp = await fetch('<%= bulk_validate_emails_path %>', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': csrf, 'Accept':'application/json' },
        body: JSON.stringify(payload)
      });

      // захист від HTML-відповідей при 500/302
      const ct  = resp.headers.get('content-type') || '';
      const raw = await resp.text();
      if (!ct.includes('application/json')) {
        throw new Error(`Сервер повернув не-JSON (${resp.status}). ${raw.slice(0,200)}…`);
      }
      const data = JSON.parse(raw);
      if(!resp.ok || !data.success) throw new Error(data.error || `Помилка сервера (${resp.status})`);

      jobId = data.job_id;

      // активуємо посилання на скачування
      dlRoleEl.classList.remove('disabled');   dlRoleEl.removeAttribute('aria-disabled');
      dlDupEl.classList.remove('disabled');    dlDupEl.removeAttribute('aria-disabled');
      dlRoleEl.href = '<%= download_emails_path %>?job_id='+encodeURIComponent(jobId)+'&kind=role';
      dlDupEl.href  = '<%= download_emails_path %>?job_id='+encodeURIComponent(jobId)+'&kind=duplicates';

      // Скидаємо UI
      updateUI({ total: 0, processed: 0, valid: 0, invalid: 0, valid_list: [], invalid_list: [], role_rejected: 0, duplicates: 0 });

      setTopListMode('invalid');
      setDetailListMode('role');

      timer = setInterval(fetchProgress, 700);
    }catch(e){
      alert('Помилка: '+e.message);
      startBtn.disabled = false; startBtn.textContent = 'Почати перевірку';
    }
  });

  // Полл прогресу
  async function fetchProgress(){
    if(!jobId) return;
    try{
      const url = '<%= progress_emails_path %>?job_id='+encodeURIComponent(jobId);
      const data = await fetch(url, { headers: { 'Accept':'application/json' } }).then(r=>r.json());
      if(!data.success) return;
      updateUI(data);
      if(data.done){
        clearInterval(timer);
        startBtn.textContent='Повторити перевірку';
        startBtn.disabled=false;
        detailLoadMoreBtn.disabled = detailEOF;
      }
    }catch(_){}
  }

  // Оновлення UI
  function updateUI(state){
    // Якщо total = 0 (стрім), для відсотків беремо processed як "поточний тотал"
    const rawTotal = parseInt(state.total || 0, 10);
    const processed = parseInt(state.processed || 0, 10);
    const total = rawTotal > 0 ? rawTotal : processed;

    const valid   = parseInt(state.valid || 0, 10);
    const invalid = parseInt(state.invalid || 0, 10);
    const unknown = Math.max(0, processed - valid - invalid);

    totalEl && (totalEl.textContent = total);
    totalDupEl && (totalDupEl.textContent = total);
    processedEl && (processedEl.textContent = processed);
    processedDupEl && (processedDupEl.textContent = processed);

    barValid   && (barValid.style.width   = pct(valid, total) + '%');
    barInvalid && (barInvalid.style.width = pct(invalid, total) + '%');
    barUnknown && (barUnknown.style.width = pct(unknown, total) + '%');

    validProgEl   && (validProgEl.textContent   = valid);
    invalidProgEl && (invalidProgEl.textContent = invalid);
    unknownProgEl && (unknownProgEl.textContent = unknown);

    validBadgeEl   && (validBadgeEl.textContent   = valid);
    invalidBadgeEl && (invalidBadgeEl.textContent = invalid);

    roleBadgeDetailEl && (roleBadgeDetailEl.textContent = state.role_rejected || 0);
    dupBadgeDetailEl  && (dupBadgeDetailEl.textContent  = (state.duplicates != null ? state.duplicates : state.duplicate_count) || 0);

    validList   = Array.isArray(state.valid_list)   ? state.valid_list   : [];
    invalidList = Array.isArray(state.invalid_list) ? state.invalid_list : [];

    setTopListMode(currentListModeTop);
  }
</script>
