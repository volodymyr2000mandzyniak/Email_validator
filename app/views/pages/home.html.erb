<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card">
        <div class="card-header">
          <h1 class="h3 mb-0">Email Validator</h1>
          <p class="text-muted mb-0">Завантажте файл з email-адресами для перевірки</p>
        </div>
        
        <div class="card-body">
          <!-- Drop Zone -->
          <div class="drop-zone mb-4 p-5 border-2 border-dashed border-gray-300 rounded-lg text-center"
               id="dropZone">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="text-muted mb-3" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
            </svg>
            <p class="text-muted">Перетягніть файл сюди або</p>
            <label for="fileInput" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
              </svg>
              Обрати файл
            </label>
            <input type="file" id="fileInput" class="d-none" 
                   accept=".txt,.csv,.json,.xlsx,.xls" 
                   onchange="handleFileSelect(this.files)">
          </div>

          <!-- File Info -->
          <div id="fileInfo" class="alert alert-info d-none">
            <h5 class="alert-heading">Обраний файл:</h5>
            <div id="fileDetails"></div>
          </div>

          <!-- File Preview -->
          <div id="filePreview" class="card d-none mt-4">
            <div class="card-header">
              <h6 class="mb-0">Попередній перегляд вмісту:</h6>
            </div>
            <div class="card-body">
              <pre id="previewContent" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"></pre>
            </div>
          </div>

          <!-- Actions -->
          <div id="fileActions" class="mt-4 d-none">
            <button class="btn btn-success btn-lg" onclick="processFile()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M10.97 7.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.235.235 0 0 1 .02-.022z"/>
              </svg>
              Почати перевірку
            </button>
            <button class="btn btn-outline-secondary btn-lg ml-2" onclick="resetFile()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
              </svg>
              Скинути
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden form for actual file upload -->
<%= form_with url: '/upload', method: :post, html: { id: 'uploadForm', class: 'd-none' } do |form| %>
  <%= form.file_field :file, id: 'hiddenFileInput' %>
<% end %>

<script>
// Global variable to store file data
let currentFile = null;

// Drag and drop functionality
const dropZone = document.getElementById('dropZone');
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
  dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight() {
  dropZone.classList.add('border-primary');
  dropZone.classList.add('bg-light');
}

function unhighlight() {
  dropZone.classList.remove('border-primary');
  dropZone.classList.remove('bg-light');
}

dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  handleFileSelect(files);
}

function handleFileSelect(files) {
  if (files.length === 0) return;
  
  const file = files[0];
  currentFile = file;
  
  // Show file info
  document.getElementById('fileInfo').classList.remove('d-none');
  document.getElementById('fileDetails').innerHTML = `
    <p><strong>Назва:</strong> ${file.name}</p>
    <p><strong>Тип:</strong> ${file.type || 'невідомий'}</p>
    <p><strong>Розмір:</strong> ${formatFileSize(file.size)}</p>
  `;
  
  // Show actions
  document.getElementById('fileActions').classList.remove('d-none');
  
  // Read and preview file content
  previewFileContent(file);
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function previewFileContent(file) {
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const content = e.target.result;
    document.getElementById('filePreview').classList.remove('d-none');
    
    // Limit preview to first 1000 characters
    const previewContent = content.length > 1000 
      ? content.substring(0, 1000) + '...' 
      : content;
    
    document.getElementById('previewContent').textContent = previewContent;
  };
  
  reader.onerror = function() {
    document.getElementById('previewContent').textContent = 'Помилка читання файлу';
  };
  
  // Read based on file type
  if (file.type === 'application/json' || file.name.endsWith('.json')) {
    reader.readAsText(file);
  } else if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
    reader.readAsText(file);
  } else if (file.type.includes('text/') || file.name.endsWith('.txt')) {
    reader.readAsText(file);
  } else {
    document.getElementById('previewContent').textContent = 'Попередній перегляд недоступний для цього типу файлу';
  }
}

function processFile() {
  if (!currentFile) return;
  
  // Create FormData and submit
  const formData = new FormData();
  formData.append('file', currentFile);
  
  fetch('/upload', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.href = '/process';
    } else {
      alert('Помилка завантаження файлу: ' + data.error);
    }
  })
  .catch(error => {
    alert('Помилка: ' + error.message);
  });
}

function resetFile() {
  currentFile = null;
  document.getElementById('fileInfo').classList.add('d-none');
  document.getElementById('filePreview').classList.add('d-none');
  document.getElementById('fileActions').classList.add('d-none');
  document.getElementById('fileInput').value = '';
  
  // Clear preview content
  document.getElementById('previewContent').textContent = '';
  
  // Clear file details
  document.getElementById('fileDetails').innerHTML = '';
}
</script>

<style>
.drop-zone {
  border: 2px dashed #ccc;
  border-radius: 10px;
  transition: all 0.3s ease;
}

.drop-zone:hover {
  border-color: #007bff;
  background-color: #f8f9fa;
}

.border-dashed {
  border-style: dashed;
}
</style>